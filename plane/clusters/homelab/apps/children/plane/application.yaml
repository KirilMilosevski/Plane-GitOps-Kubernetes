apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: plane
  namespace: argocd
spec:
  project: default

  sources:
    # Source 1: Plane Helm chart (NO ingress here)
    - repoURL: https://helm.plane.so
      chart: plane-ce
      targetRevision: "1.4.1"
      helm:
        values: |
          ingress:
            enabled: false
            appHost: "plane.homelab"
            minioHost: ""
            ingressClass: ""

          # âœ… Plane public URL + CORS (these are app config, not ingress routing)
          # The exact nesting depends on the chart, but these keys must end up
          # as env vars on the API pod.
        
          env:
            cors_allowed_origins: "http://plane.homelab"
            web_url: "http://plane.homelab"

          postgres:
            storageClass: local-path
          redis:
            storageClass: local-path
          minio:
            storageClass: local-path

    # Source 2: Your Git repo (custom ingress + extras)
    - repoURL: https://github.com/KirilMilosevski/Plane-GitOps-Kubernetes.git
      targetRevision: main
      path: plane/clusters/homelab/ingress

  destination:
    server: https://kubernetes.default.svc
    namespace: plane

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ApplyOutOfSyncOnly=true
      - PruneLast=true

  ignoreDifferences:
    - group: batch
      kind: Job
      jqPathExpressions:
        - .spec.template
        - .spec.template.metadata.labels

